# What are cookies? And why will you use it?

Cookies are small pieces of data stored in the browser by websites. They are one of the earliest web technologies for maintaining state and persist information across HTTP requests. Understanding cookies is essential for web developers, especially for authentication, tracking, and user experience features.

## What are Cookies?

**Cookies** are key-value pairs of data that servers can store on the client-side (user's browser). When a user visits a website, the server can send cookies to the browser, which stores them and sends them back with subsequent requests to that domain.

### Key Characteristics

- **Text-based**: Simple text data (key-value pairs)
- **Limited size**: Maximum ~4KB per cookie
- **Automatic**: Sent automatically with every HTTP request to the domain
- **Domain-specific**: Only accessible by the originating domain
- **Expiration**: Can be temporary (session) or persistent

## How Cookies Work

### Cookie Flow
```
1. User visits website
   ↓
2. Server responds with Set-Cookie header
   ↓
3. Browser stores cookie
   ↓
4. Future requests to same domain include cookie
   ↓
5. Server reads cookie from request
```

### Setting Cookies (Server-side)

```javascript
// Express.js example
app.get('/login', (req, res) => {
  // Set session cookie
  res.cookie('sessionId', 'abc123', {
    httpOnly: true,
    secure: true,
    sameSite: 'strict'
  });
  res.send('Logged in');
});

// Set multiple cookies
app.get('/set-cookies', (req, res) => {
  res.cookie('theme', 'dark', { maxAge: 86400000 }); // 24 hours
  res.cookie('language', 'en', { maxAge: 604800000 }); // 1 week
  res.send('Cookies set');
});
```

### Accessing Cookies (Server-side)

```javascript
app.get('/profile', (req, res) => {
  const sessionId = req.cookies.sessionId;
  const theme = req.cookies.theme;

  if (!sessionId) {
    return res.status(401).send('Not authenticated');
  }

  res.json({ theme, user: 'authenticated' });
});
```

### Client-side JavaScript

```javascript
// Setting cookies from JavaScript (not recommended for sensitive data)
document.cookie = 'theme=dark; max-age=86400; path=/; secure';

// Reading cookies
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

const theme = getCookie('theme');
console.log(theme); // 'dark'
```

## Cookie Types

### **Session Cookies**
- **Lifetime**: Exist only during the browser session
- **Deleted when**: Browser tab/window is closed
- No expiry date set

```javascript
// Session cookie (no maxAge or expires)
res.cookie('sessionId', 'abc123');

// Alternative: Set expires to 0
res.cookie('temp', 'value', { expires: new Date(0) });
```

### **Persistent Cookies**
- **Lifetime**: Survive browser restarts
- **Deleted when**: Expiry date reached or manually deleted
- Set with `maxAge` or `expires`

```javascript
// Persistent cookie for 30 days
res.cookie('rememberUser', 'john@example.com', {
  maxAge: 30 * 24 * 60 * 60 * 1000 // 30 days in milliseconds
});

// Alternative with expires
res.cookie('preference', 'notifications=on', {
  expires: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
});
```

### **Secure Cookies**
- **Transmission**: Only sent over HTTPS
- **Security**: Encrypted in transit
- Set with `secure` flag

```javascript
res.cookie('authToken', 'secret-token', {
  secure: true,    // HTTPS only
  httpOnly: true,  // No JavaScript access
  sameSite: 'strict' // CSRF protection
});
```

### **HttpOnly Cookies**
- **Access**: Cannot be read/modified by JavaScript
- **Purpose**: Prevents XSS attacks from stealing cookies
- Set with `httpOnly` flag

```javascript
// HttpOnly cookie for session tokens
res.cookie('sessionToken', 'jwt-token-here', {
  httpOnly: true,
  secure: true,
  sameSite: 'strict'
});

// Cannot access from JavaScript:
// console.log(document.cookie); // Won't show httpOnly cookies
```

## Cookie Attributes

### **Core Attributes**

| Attribute | Description | Example |
|-----------|-------------|---------|
| `name` | Cookie name | `sessionId` |
| `value` | Cookie value | `abc123` |
| `domain` | Domain scope | `.example.com` |
| `path` | Path scope | `/api` |
| `expires` | Expiration date | `Wed, 21 Oct 2025 07:28:00 GMT` |
| `max-age` | Lifetime in seconds | `86400` |

### **Security Attributes**

| Attribute | Purpose | Protection |
|-----------|---------|------------|
| `secure` | HTTPS only | Network interception |
| `httpOnly` | No JS access | XSS attacks |
| `sameSite` | CSRF protection | Cross-site request forgery |

## Practical Use Cases

### **Authentication & Sessions**
```javascript
// User login - set session cookie
app.post('/login', (req, res) => {
  // Authenticate user...
  const sessionToken = generateJWToken(userData);

  res.cookie('authToken', sessionToken, {
    httpOnly: true,
    secure: true,
    sameSite: 'strict',
    maxAge: 7 * 24 * 60 * 60 * 1000 // 7 days
  });

  res.json({ status: 'logged in' });
});

// Protected route - verify cookie
app.get('/dashboard', authenticateCookie, (req, res) => {
  res.json({ userData: req.user });
});
```

### **User Preferences**
```javascript
// Store user theme preference
app.post('/preferences', (req, res) => {
  res.cookie('theme', req.body.theme, {
    maxAge: 365 * 24 * 60 * 60 * 1000, // 1 year
    path: '/'
  });
  res.send('Preference saved');
});

// Apply preference on page load
app.get('/', (req, res) => {
  const theme = req.cookies.theme || 'light';
  res.render('index', { theme });
});
```

### **Analytics & Tracking**
```javascript
// Unique visitor tracking
app.use((req, res, next) => {
  let visitorId = req.cookies.visitorId;

  if (!visitorId) {
    visitorId = generateUniqueId();
    res.cookie('visitorId', visitorId, { maxAge: 2 * 365 * 24 * 60 * 60 * 1000 });
    // Log new visitor
    trackNewVisitor(visitorId);
  } else {
    // Update visit count
    updateVisitCount(visitorId);
  }

  next();
});
```

### **A/B Testing**
```javascript
app.get('/experiment', (req, res) => {
  let group = req.cookies.abGroup;

  if (!group) {
    group = Math.random() < 0.5 ? 'A' : 'B';
    res.cookie('abGroup', group, { maxAge: 30 * 24 * 60 * 60 * 1000 });
  }

  // Show different content based on group
  const data = group === 'A' ? experimentAData : experimentBData;
  res.render('experiment', data);
});
```

### **CSRF Protection**
```javascript
// Generate and set CSRF token
app.get('/form', (req, res) => {
  const csrfToken = generateCSRFToken();
  res.cookie('csrfToken', csrfToken, {
    httpOnly: true,
    secure: true,
    sameSite: 'strict'
  });
  res.render('form', { csrfToken });
});

// Validate CSRF token on form submission
app.post('/submit', (req, res) => {
  const cookieToken = req.cookies.csrfToken;
  const formToken = req.body.csrfToken;

  if (!cookieToken || cookieToken !== formToken) {
    return res.status(403).send('CSRF detected');
  }

  // Process form...
});
```

## Cookies vs Local Storage vs Session Storage

| Feature | Cookies | Local Storage | Session Storage |
|---------|---------|----------------|-----------------|
| **Capacity** | ~4KB | ~5MB | ~5MB |
| **Automatic sending** | Yes (every request) | No | No |
| **Server access** | Yes | No | No |
| **JavaScript access** | Limited (no httpOnly) | Full | Full |
| **Expiration** | Can set | Manual only | Session ends |
| **Security** | Secure flags available | None | None |
| **Performance** | Increases request size | Faster | Faster |

### **When to use Cookies over Storage:**

1. **Server-side access needed**
2. **Authentication tokens**
3. **Cross-subdomain sharing**
4. **Expiration management**
5. **CSRF protection**

### **When to use Storage over Cookies:**

1. **Large data storage**
2. **Client-side only data**
3. **No server communication needed**
4. **Complex data structures**

## Security Best Practices

### **Always set security flags:**
```javascript
res.cookie('sensitiveData', value, {
  httpOnly: true,    // Prevents XSS access
  secure: true,      // HTTPS only
  sameSite: 'strict' // CSRF protection
});
```

### **Use appropriate domain/path scope:**
```javascript
// Restrict to specific path
res.cookie('adminSession', token, {
  path: '/admin',
  domain: 'example.com'
});

// Subdomain sharing
res.cookie('sharedPref', value, {
  domain: '.example.com'  // Works for all subdomains
});
```

### **Rotate sensitive cookies:**
```javascript
// Periodically refresh session cookies
app.use((req, res, next) => {
  if (req.cookies.sessionId) {
    // Generate new session ID
    const newSessionId = refreshSession(req.cookies.sessionId);

    // Set new cookie with fresh expiration
    res.cookie('sessionId', newSessionId, {
      httpOnly: true,
      secure: true,
      maxAge: 3600000  // 1 hour
    });
  }
  next();
});
```

### **Implement logout properly:**
```javascript
app.post('/logout', (req, res) => {
  // Clear all session cookies
  res.clearCookie('sessionId');
  res.clearCookie('authToken');
  res.clearCookie('csrfToken');

  // Invalidate server-side session
  invalidateSession(req.cookies.sessionId);

  res.json({ status: 'logged out' });
});
```

## Common Pitfalls

### **Cookie Size Limit**
```javascript
// Bad: Storing large data
const userData = getAllUserData(); // Could be > 4KB
res.cookie('userData', JSON.stringify(userData)); // May fail

// Good: Store reference only
const dataId = storeLargeDataSomewhere(userData);
res.cookie('dataId', dataId); // Much smaller
```

### **Ignoring Encoding**
```javascript
// Bad: Special characters can break
res.cookie('name', 'John;Doe=Value'); // Semicolon causes issues

// Good: Proper encoding
res.cookie('name', encodeURIComponent('John;Doe=Value'));
```

### **Overusing Cookies**
```javascript
// Bad: Too many cookies increase request size
res.cookie('pref1', '...');
res.cookie('pref2', '...');
// ... 20+ cookies

// Good: Consolidate or use storage
res.cookie('preferences', JSON.stringify(allPrefs));
```

## Browser Developer Tools

### **Inspecting Cookies:**
- **Chrome DevTools**: Application → Cookies
- **Firefox**: Storage → Cookies
- View: Name, Value, Domain, Path, Expires, HTTP, Secure, SameSite

### **Programmatic Cookie Management:**
```javascript
// Use libraries for better cookie handling
const cookies = require('cookie-parser'); // Express middleware
const Cookies = require('js-cookie'); // Client-side library

// Better parsing and validation
```

## Interview Questions

### Q: What's the difference between cookies and web storage?
**A**: Cookies are sent with every HTTP request automatically, have ~4KB limit, and can be secured with httpOnly/secure flags. Storage stays in browser only, has much larger capacity (~5MB), and isn't sent with requests.

### Q: Why use httpOnly cookies?
**A**: httpOnly prevents JavaScript access to cookies, protecting against XSS attacks where malicious scripts could steal authentication tokens.

### Q: Can cookies be shared across subdomains?
**A**: Yes, by setting the domain attribute to `.example.com` - the leading dot allows sharing across all subdomains.

### Q: What is cookie poisoning?
**A**: When an attacker forges or modifies cookie values to impersonate users or bypass security controls.

### Q: Should you store JWT tokens in cookies or localStorage?
**A**: Cookies with httpOnly/secure/sameSite flags are generally safer for JWT tokens as they're protected from XSS attacks and sent automatically.

Cookies remain a fundamental web technology despite the rise of newer storage mechanisms because of their unique combination of automatic server communication, security controls, and cross-domain capabilities. They're essential for authentication, tracking, and maintaining user state in web applications.
